/*! Multisite Admin Notices - v0.1.0
 * http://stephenharris.info
 */
"undefined"==typeof MSAN_SCRIPT_DEBUG&&(MSAN_SCRIPT_DEBUG=!0),function(e){MSAN_SCRIPT_DEBUG&&console.log(msan);var t=msan.app={Model:{},View:{},Collection:{}};msan.gettext=function(e){return void 0!==this.locale[e]?this.locale[e]:e},msan.add_query_arg=function(e,t,n){var i=RegExp("([?&])"+e+"=.*?(&|$)","i"),o=-1!==n.indexOf("?")?"&":"?";return n.match(i)?n.replace(i,"$1"+e+"="+t+"$2"):n+o+e+"="+t},msan.format_date=function(e,t){var n,i,o=this,r=["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur","January","February","March","April","May","June","July","August","September","October","November","December"],a=/\\?(.?)/gi,c=function(e,t){return i[e]?i[e]():t},s=function(e,t){for(e+="";t>e.length;)e="0"+e;return e};return i={d:function(){return s(i.j(),2)},D:function(){return i.l().slice(0,3)},j:function(){return n.getDate()},l:function(){return r[i.w()]+"day"},N:function(){return i.w()||7},S:function(){var e=i.j(),t=e%10;return 3>=t&&1==parseInt(e%100/10,10)&&(t=0),["st","nd","rd"][t-1]||"th"},w:function(){return n.getDay()},z:function(){var e=new Date(i.Y(),i.n()-1,i.j()),t=new Date(i.Y(),0,1);return Math.round((e-t)/864e5)},W:function(){var e=new Date(i.Y(),i.n()-1,i.j()-i.N()+3),t=new Date(e.getFullYear(),0,4);return s(1+Math.round((e-t)/864e5/7),2)},F:function(){return r[6+i.n()]},m:function(){return s(i.n(),2)},M:function(){return i.F().slice(0,3)},n:function(){return n.getMonth()+1},t:function(){return new Date(i.Y(),i.n(),0).getDate()},L:function(){var e=i.Y();return 0===e%4&0!==e%100|0===e%400},o:function(){var e=i.n(),t=i.W(),n=i.Y();return n+(12===e&&9>t?1:1===e&&t>9?-1:0)},Y:function(){return n.getFullYear()},y:function(){return(""+i.Y()).slice(-2)},a:function(){return n.getHours()>11?"pm":"am"},A:function(){return i.a().toUpperCase()},B:function(){var e=3600*n.getUTCHours(),t=60*n.getUTCMinutes(),i=n.getUTCSeconds();return s(Math.floor((e+t+i+3600)/86.4)%1e3,3)},g:function(){return i.G()%12||12},G:function(){return n.getHours()},h:function(){return s(i.g(),2)},H:function(){return s(i.G(),2)},i:function(){return s(n.getMinutes(),2)},s:function(){return s(n.getSeconds(),2)},u:function(){return s(1e3*n.getMilliseconds(),6)},e:function(){throw"Not supported (see source code of date() for timezone on how to add support)"},I:function(){var e=new Date(i.Y(),0),t=Date.UTC(i.Y(),0),n=new Date(i.Y(),6),o=Date.UTC(i.Y(),6);return e-t!==n-o?1:0},O:function(){var e=n.getTimezoneOffset(),t=Math.abs(e);return(e>0?"-":"+")+s(100*Math.floor(t/60)+t%60,4)},P:function(){var e=i.O();return e.substr(0,3)+":"+e.substr(3,2)},T:function(){return"UTC"},Z:function(){return 60*-n.getTimezoneOffset()},c:function(){return"Y-m-d\\TH:i:sP".replace(a,c)},r:function(){return"D, d M Y H:i:s O".replace(a,c)},U:function(){return 0|n/1e3}},this.date=function(e,t){return o=this,n=void 0===t?new Date:t instanceof Date?new Date(t):new Date(1e3*t),e.replace(a,c)},this.date(e,t)},t.Model.Controller=Backbone.Model.extend({initialize:function(){this.get("notices")&&(this.notices=new t.Collection.Notices(this.get("notices")),this.set("notices",!1))}}),t.Model.Notice=Backbone.Model.extend({url:function(){var e=msan.add_query_arg("action","msan-notice",msan.url);return e=msan.add_query_arg("_ajax_nonce",msan.nonce,e),this.isNew()?e:e+"&id="+this.id}}),t.Collection.Notices=Backbone.Collection.extend({model:t.Model.Notice}),t.View.NoticeView=Backbone.View.extend({tagName:"li",templateRead:_.template(e("#tmpl-msan-notice").html()),templateEdit:_.template(e("#tmpl-msan-notice-edit").html()),initialize:function(){_.bindAll(this,"render"),this.listenTo(this.model,"destroy",this.removeNotice,this)},events:{"click .msan-delete-notice":"deleteNotice","click .msan-edit-notice":"editNotice","click .msan-update-notice":"updateNotice","click .msan-cancel-update":"cancelUpdateNotice"},render:function(){return e(this.el).html(this.templateRead(this.getTemplateArgs())),e(this.el).attr("id","msan-notice-"+this.model.cid),this},renderEdit:function(){return e(this.el).html(this.templateEdit(this.getTemplateArgs())),this},getTemplateArgs:function(){var e=this.model.toJSON(),t=new Date(this.model.get("last_updated"));return e.last_update=msan.format_date("jS F Y H:i",t),e},deleteNotice:function(e){e.preventDefault(),this.model.destroy()},updateNotice:function(t){t.preventDefault();var n=e("textarea",this.el).val();this.model.set("message",n),this.model.set("last_updated",msan.format_date("Y-m-d H:i:s")),this.model.save(),this.render(),this.model.trigger("move-to-top",this.model)},cancelUpdateNotice:function(e){e.preventDefault(),this.render()},removeNotice:function(){e(this.el).remove()},editNotice:function(t){t.preventDefault(),this.renderEdit(),e("textarea",this.el).focus()}}),t.View.ControllerView=Backbone.View.extend({el:"#msan-notices",events:{"click .button":"publishNotice"},initialize:function(){_.bindAll(this,"render","addNotice","moveToTop");var e=this;this.listenTo(this.model.notices,"add",this.addNotice,this),this.listenTo(this.model.notices,"move-to-top",function(t){e.moveToTop(t)})},render:function(){var e=this;this.model.notices&&this.model.notices.each(function(t){e.addNotice(t,!1)})},publishNotice:function(n){n.preventDefault();var i=e("textarea",this.el).val();if(i){var o=new t.Model.Notice({message:i,last_updated:msan.format_date("Y-m-d H:i:s")});o.save(),this.model.notices.add(o)}},addNotice:function(n,i){i="undefined "==typeof i?!0:i,noticeView=new t.View.NoticeView({model:n});var o=noticeView.render().el;$list=e("ul",this.el),i?e(o).css({opacity:0}).prependTo($list).animate({opacity:1},1500):e(o).prependTo($list)},moveToTop:function(t){var n=e("ul",this.el);n.innerHeight();var i=n.position().top,o=e("#msan-notice-"+t.cid),r=o.attr("id"),a=o.height(),c=o.position().top;o.clone().wrap("<div></div>").parent().html();var s=i-c,u=a;e("li",this.el).each(function(){return e(this).attr("id")==r?!1:(e(this).animate({top:"+="+u},1e3),void 0)}),o.animate({top:"+="+s},1e3,function(){o.prependTo(n),e("li").attr("style","")})}}),e(document).ready(function(){var e=new t.Model.Controller({notices:msan.notices}),n=new t.View.ControllerView({model:e});n.render()})}(jQuery);